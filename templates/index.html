{% extends "base.html" %}

{% block content %}
    {% include 'login.html' %}
    {% include 'dash_student.html' %}
    {% include 'dash_tutor.html' %}
    {% include 'dash_teacher.html' %}
{% endblock %}

{% block scripts %}
<script>
    let currentUser = null;
    let currentRole = null;

    async function login() {
        const u = document.getElementById('u').value;
        const p = document.getElementById('p').value;
        const res = await fetch('/api/login', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({username: u, password: p}) });
        const data = await res.json();
        
        if(data.status === 'ok') {
            currentUser = u;
            currentRole = data.role;
            document.getElementById('login-view').classList.add('hidden');
            loadDashboard();
        } else { alert("Login Failed"); }
    }

    async function loadDashboard() {
        const res = await fetch('/api/dashboard', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({username: currentUser, role: currentRole}) });
        const data = await res.json();

        if(currentRole === 'student') {
            document.getElementById('student-view').classList.remove('hidden');
            document.getElementById('stu-name').innerText = data.profile.name;
            document.getElementById('stu-id').innerText = data.profile.id;
            document.getElementById('stu-class').innerText = data.profile.class;
            document.getElementById('stu-nat').innerText = data.profile.nationality;
            document.getElementById('stu-dob').innerText = data.profile.dob;
            document.getElementById('stu-addr').innerText = data.profile.address;

            document.getElementById('stu-table').innerHTML = data.transcript.map(t => {
                let bg = t.is_banned ? 'var(--red)' : (t.status==='PASS' ? 'var(--green)' : '#f39c12');
                return `<tr><td>${t.subject}</td><td style="color:${t.is_banned?'red':'inherit'}">${t.absent}h / ${t.limit}h</td><td>${t.sem_score}</td><td>${t.exam||'-'}</td><td><span class="badge" style="background:${bg}">${t.status}</span></td></tr>`;
            }).join('');
            document.getElementById('stu-schedule').innerHTML = data.schedule.map(s => `<div><b>${s.day} ${s.time}</b>: ${s.subject} (${s.type})</div>`).join('');
        
        } else if(currentRole === 'tutor') {
            document.getElementById('tutor-view').classList.remove('hidden');
            const subs = Object.keys(data.subjects);
            document.getElementById('tutor-subj').innerHTML = subs.map(s => `<option value="${s}">${s} (Teacher: ${data.subjects[s].teacher})</option>`).join('');
            document.getElementById('tutor-teacher-list').innerHTML = data.teachers.map(t => `<option value="${t}">${t}</option>`).join('');
        
        } else if(currentRole === 'teacher') {
            document.getElementById('teacher-view').classList.remove('hidden');
            const subs = Object.keys(data.subjects);
            document.getElementById('teach-subj').innerHTML = subs.map(s => `<option value="${s}">${s}</option>`).join('');
            document.getElementById('teach-stu').innerHTML = data.students.map(s => `<option value="${s}">${s}</option>`).join('');
        }
    }

    // Helpers
    function val(id) { return document.getElementById(id).value; }
    async function post(url, body) {
        const r = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) });
        return await r.json();
    }

    // Actions
    async function tutorAssign() { await post('/api/tutor/manage', {action:'assign_teacher', subject:val('tutor-subj'), teacher:val('tutor-teacher-list')}); alert("Assigned"); }
    async function tutorWorkload() { await post('/api/tutor/manage', {action:'set_workload', subject:val('tutor-subj'), hours:val('tutor-hours')}); alert("Updated"); }
    async function tutorSchedule() { await post('/api/tutor/manage', {action:'add_schedule', subject:val('tutor-subj'), day:val('sch-day'), time:val('sch-time'), class:val('sch-class'), type:val('sch-type')}); alert("Added"); }

    async function teacherAction(act) {
        const d = await post('/api/teacher/grade', {student:val('teach-stu'), subject:val('teach-subj'), action:act, value: (act==='absence'?0:val(act==='mark'?'grade-val':(act==='freelance'?'free-val':'exam-val')))});
        document.getElementById('grade-msg').innerText = `Status: ${d.stats.status} | Total: ${d.stats.total}`;
    }
</script>
{% endblock %}
